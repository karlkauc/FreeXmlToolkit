name: Build and Release Executables

# Dieser Workflow wird bei jedem neuen Release gestartet
on:
  release:
    types: [ created ]

jobs:
  build:
    # Definiere eine Build-Matrix für verschiedene Betriebssysteme und Architekturen
    strategy:
      matrix:
        include:
          # Windows builds - EXE packages
          - os: windows-latest
            arch: x64
            gradle-tasks: createWindowsExecutableX64
          - os: windows-latest
            arch: arm64
            gradle-tasks: createWindowsExecutableArm64
          
          # Windows builds - MSI packages
          - os: windows-latest
            arch: x64
            gradle-tasks: createWindowsMsiX64
          - os: windows-latest
            arch: arm64
            gradle-tasks: createWindowsMsiArm64
          
          # Windows builds - App Images
          - os: windows-latest
            arch: x64
            gradle-tasks: zipWindowsAppImageX64
          - os: windows-latest
            arch: arm64
            gradle-tasks: zipWindowsAppImageArm64
          
          # macOS builds - DMG packages
          - os: macos-15  # ARM runner, cross-compiles for x64
            arch: x64
            gradle-tasks: createMacOSExecutableX64
          - os: macos-15  # ARM runner, native ARM build
            arch: arm64
            gradle-tasks: createMacOSExecutableArm64
          
          # macOS builds - PKG packages
          - os: macos-15  # ARM runner, cross-compiles for x64
            arch: x64
            gradle-tasks: createMacOSPkgX64
          - os: macos-15  # ARM runner, native ARM build
            arch: arm64
            gradle-tasks: createMacOSPkgArm64
          
          # macOS builds - App Images
          - os: macos-15  # ARM runner, cross-compiles for x64
            arch: x64
            gradle-tasks: zipMacOSAppImageX64
          - os: macos-15  # ARM runner, native ARM build
            arch: arm64
            gradle-tasks: zipMacOSAppImageArm64
          
          # Linux builds - DEB packages
          - os: ubuntu-latest
            arch: x64
            gradle-tasks: createLinuxDebX64
          - os: ubuntu-latest
            arch: arm64
            gradle-tasks: createLinuxDebArm64
          
          # Linux builds - RPM packages
          - os: ubuntu-latest
            arch: x64
            gradle-tasks: createLinuxRpmX64
          - os: ubuntu-latest
            arch: arm64
            gradle-tasks: createLinuxRpmArm64
          
          # Linux builds - App Images
          - os: ubuntu-latest
            arch: x64
            gradle-tasks: zipLinuxAppImageX64
          - os: ubuntu-latest
            arch: arm64
            gradle-tasks: zipLinuxAppImageArm64

    # Der Job wird auf dem in der Matrix definierten Betriebssystem ausgeführt
    runs-on: ${{ matrix.os }}

    steps:
      # Schritt 1: Code auschecken
      - name: Checkout repository
        uses: actions/checkout@v5

      # Schritt 2: Java Development Kit (JDK) einrichten
      # Stelle sicher, dass du eine JDK-Version wählst, die jpackage enthält (JDK 14+)
      - name: Set up JDK
        uses: actions/setup-java@v5
        with:
          java-package: 'jdk+fx'
          java-version: '24'
          distribution: 'liberica'

      # Schritt 3: Gradle Wrapper ausführbar machen (wichtig für Linux/macOS)
      - name: Make Gradle wrapper executable
        if: runner.os != 'Windows'
        run: chmod +x ./gradlew

      # Schritt 4: Führe die architektur-spezifischen Gradle-Tasks aus
      - name: Build with Gradle (${{ matrix.arch }})
        run: ./gradlew ${{ matrix.gradle-tasks }}

      # Schritt 5: Lade alle erstellten Artefakte mit dem GitHub CLI hoch
      - name: Upload Release Assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh release upload ${{ github.event.release.tag_name }} build/dist/*
