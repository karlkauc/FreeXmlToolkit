name: Build and Release Executables

# Dieser Workflow wird bei jedem neuen Release gestartet
on:
  release:
    types: [ created ]

jobs:
  build:
    # Definiere eine Build-Matrix nur für gezippte App-Images
    strategy:
      matrix:
        include:
          # Windows builds - App Images (zipped only)
          - os: windows-latest
            arch: x64
            gradle-tasks: createWindowsAppImageX64Zip
          - os: windows-latest
            arch: arm64
            gradle-tasks: createWindowsAppImageArm64Zip
          
          # macOS builds - App Images (zipped only)
          - os: macos-15  # ARM runner, cross-compiles for x64
            arch: x64
            gradle-tasks: createMacOSAppImageX64Zip
          - os: macos-15  # ARM runner, native ARM build
            arch: arm64
            gradle-tasks: createMacOSAppImageArm64Zip
          
          # Linux builds - App Images (zipped only)
          - os: ubuntu-latest
            arch: x64
            gradle-tasks: createLinuxAppImageX64Zip
          - os: ubuntu-latest
            arch: arm64
            gradle-tasks: createLinuxAppImageArm64Zip

    # Der Job wird auf dem in der Matrix definierten Betriebssystem ausgeführt
    runs-on: ${{ matrix.os }}

    steps:
      # Schritt 1: Code auschecken
      - name: Checkout repository
        uses: actions/checkout@v5

      # Schritt 2: Java Development Kit (JDK) einrichten
      # Stelle sicher, dass du eine JDK-Version wählst, die jpackage enthält (JDK 14+)
      - name: Set up JDK
        uses: actions/setup-java@v5
        with:
          java-package: 'jdk+fx'
          java-version: '24'
          distribution: 'liberica'

      # Schritt 3: Gradle Wrapper ausführbar machen (wichtig für Linux/macOS)
      - name: Make Gradle wrapper executable
        if: runner.os != 'Windows'
        run: chmod +x ./gradlew

      # Schritt 4: Führe die architektur-spezifischen Gradle-Tasks aus
      - name: Build with Gradle (${{ matrix.arch }})
        run: ./gradlew ${{ matrix.gradle-tasks }}

      # Schritt 5: Lade alle erstellten Artefakte mit dem GitHub CLI hoch
      - name: Upload Release Assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh release upload ${{ github.event.release.tag_name }} build/dist/*
