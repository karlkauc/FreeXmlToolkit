name: Build and Release Executables

# Dieser Workflow wird bei jedem neuen Release gestartet
on:
  release:
    types: [ created ]

jobs:
  build:
    # Definiere eine Build-Matrix fÃ¼r alle jpackage Kombinationen
    strategy:
      matrix:
        include:
          # Windows builds - alle Formate fÃ¼r beide Architekturen
          - os: windows-latest
            arch: x64
            gradle-tasks: createWindowsExecutableX64
            artifact-pattern: "*.exe"
          - os: windows-latest
            arch: x64
            gradle-tasks: createWindowsMsiX64
            artifact-pattern: "*.msi"
          - os: windows-latest
            arch: x64
            gradle-tasks: createWindowsAppImageX64Zip
            artifact-pattern: "*.zip"
          - os: windows-latest
            arch: arm64
            gradle-tasks: createWindowsExecutableArm64
            artifact-pattern: "*.exe"
          - os: windows-latest
            arch: arm64
            gradle-tasks: createWindowsMsiArm64
            artifact-pattern: "*.msi"
          - os: windows-latest
            arch: arm64
            gradle-tasks: createWindowsAppImageArm64Zip
            artifact-pattern: "*.zip"
          
          # macOS builds - alle Formate fÃ¼r beide Architekturen
          - os: macos-15  # ARM runner, cross-compiles for x64
            arch: x64
            gradle-tasks: createMacOSExecutableX64
            artifact-pattern: "*.dmg"
          - os: macos-15  # ARM runner, cross-compiles for x64
            arch: x64
            gradle-tasks: createMacOSPkgX64
            artifact-pattern: "*.pkg"
          - os: macos-15  # ARM runner, cross-compiles for x64
            arch: x64
            gradle-tasks: createMacOSAppImageX64Zip
            artifact-pattern: "*.zip"
          - os: macos-15  # ARM runner, native ARM build
            arch: arm64
            gradle-tasks: createMacOSExecutableArm64
            artifact-pattern: "*.dmg"
          - os: macos-15  # ARM runner, native ARM build
            arch: arm64
            gradle-tasks: createMacOSPkgArm64
            artifact-pattern: "*.pkg"
          - os: macos-15  # ARM runner, native ARM build
            arch: arm64
            gradle-tasks: createMacOSAppImageArm64Zip
            artifact-pattern: "*.zip"
          
          # Linux builds - alle Formate fÃ¼r beide Architekturen
          - os: ubuntu-latest
            arch: x64
            gradle-tasks: createLinuxDebX64
            artifact-pattern: "*.deb"
          - os: ubuntu-latest
            arch: x64
            gradle-tasks: createLinuxRpmX64
            artifact-pattern: "*.rpm"
          - os: ubuntu-latest
            arch: x64
            gradle-tasks: createLinuxAppImageX64Zip
            artifact-pattern: "*.zip"
          - os: ubuntu-latest
            arch: arm64
            gradle-tasks: createLinuxDebArm64
            artifact-pattern: "*.deb"
          - os: ubuntu-latest
            arch: arm64
            gradle-tasks: createLinuxRpmArm64
            artifact-pattern: "*.rpm"
          - os: ubuntu-latest
            arch: arm64
            gradle-tasks: createLinuxAppImageArm64Zip
            artifact-pattern: "*.zip"

    # Der Job wird auf dem in der Matrix definierten Betriebssystem ausgefÃ¼hrt
    runs-on: ${{ matrix.os }}

    steps:
      # Schritt 1: Code auschecken
      - name: Checkout repository
        uses: actions/checkout@v5

      # Schritt 2: Java Development Kit (JDK) einrichten
      # Stelle sicher, dass du eine JDK-Version wÃ¤hlst, die jpackage enthÃ¤lt (JDK 14+)
      - name: Set up JDK
        uses: actions/setup-java@v5
        with:
          java-package: 'jdk+fx'
          java-version: '25'
          distribution: 'liberica'

      # Schritt 3: Gradle Wrapper ausfÃ¼hrbar machen (wichtig fÃ¼r Linux/macOS)
      - name: Make Gradle wrapper executable
        if: runner.os != 'Windows'
        run: chmod +x ./gradlew

      # Schritt 4: FÃ¼hre die architektur-spezifischen Gradle-Tasks aus
      - name: Build with Gradle (${{ matrix.arch }})
        run: ./gradlew ${{ matrix.gradle-tasks }}

      # Schritt 5: Lade alle erstellten Artefakte mit dem GitHub CLI hoch
      - name: Upload Release Assets (${{ matrix.arch }})
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Upload all files matching the expected pattern
          if ls build/dist/${{ matrix.artifact-pattern }} 1> /dev/null 2>&1; then
            gh release upload ${{ github.event.release.tag_name }} build/dist/${{ matrix.artifact-pattern }}
            echo "âœ… Uploaded artifacts: build/dist/${{ matrix.artifact-pattern }}"
          else
            echo "âš ï¸  No artifacts found matching pattern: ${{ matrix.artifact-pattern }}"
            echo "ğŸ“ Contents of build/dist/:"
            ls -la build/dist/ || echo "build/dist/ directory not found"
          fi
